{% extends "parties/base.html" %}
{% load static %}

{% block content %}
<style>
    /* --- [1. ë ˆì´ì•„ì›ƒ & ë””ìì¸ (ê¸°ì¡´ ìœ ì§€)] --- */
    :root {
        --chat-bg: #36393f;        /* ì±„íŒ… ë°°ê²½ */
        --sidebar-bg: #2f3136;     /* ì‚¬ì´ë“œë°” ë°°ê²½ */
        --header-bg: #202225;      /* í—¤ë”/ì…ë ¥ì°½ ë°°ê²½ */
        --my-msg-bg: #5865F2;      /* ë‚´ ë©”ì‹œì§€ (íŒŒë€ìƒ‰) */
        --other-msg-bg: #40444b;   /* ìƒëŒ€ ë©”ì‹œì§€ (íšŒìƒ‰) */
        --text-color: #dcddde;     /* ê¸°ë³¸ í…ìŠ¤íŠ¸ */
        --muted-color: #72767d;    /* íë¦° í…ìŠ¤íŠ¸ */
    }

    .party-wrapper {
        display: flex;
        height: 85vh;
        max-width: 1200px;
        margin: 0 auto;
        gap: 16px;
        padding: 20px;
        box-sizing: border-box;
    }

    /* ì¢Œì¸¡ ì •ë³´ íŒ¨ë„ */
    .info-sidebar {
        flex: 1;
        background: var(--sidebar-bg);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        min-width: 300px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* ìš°ì¸¡ ì±„íŒ… íŒ¨ë„ */
    .chat-main {
        flex: 2.5;
        background: var(--chat-bg);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .chat-header {
        padding: 16px;
        background: var(--header-bg);
        border-bottom: 1px solid rgba(0,0,0,0.2);
        font-weight: bold;
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #chat-log {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    #chat-log::-webkit-scrollbar { width: 8px; }
    #chat-log::-webkit-scrollbar-thumb { background: #202225; border-radius: 4px; }

    .message-row { display: flex; flex-direction: column; }
    .message-row.mine { align-items: flex-end; }
    .message-row.other { align-items: flex-start; }

    .message-sender {
        font-size: 12px;
        color: var(--muted-color);
        margin-bottom: 4px;
        margin-left: 4px;
    }
    .message-bubble {
        padding: 10px 14px;
        border-radius: 8px;
        color: white;
        max-width: 70%;
        word-wrap: break-word;
        font-size: 15px;
        line-height: 1.4;
    }
    .mine .message-bubble { background: var(--my-msg-bg); border-bottom-right-radius: 0; }
    .other .message-bubble { background: var(--other-msg-bg); border-bottom-left-radius: 0; }

    .system-message {
        align-self: center;
        background: rgba(255, 255, 255, 0.05);
        color: var(--muted-color);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        margin: 10px 0;
    }

    .chat-input-area {
        padding: 20px;
        background: var(--header-bg);
        display: flex;
        gap: 10px;
    }
    .chat-input {
        flex: 1;
        background: #40444b;
        border: none;
        padding: 12px;
        border-radius: 8px;
        color: white;
        font-size: 15px;
    }
    .chat-input:focus { outline: none; background: #4f545c; }
    .send-btn {
        background: var(--my-msg-bg);
        color: white;
        border: none;
        padding: 0 24px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
    }
    .send-btn:hover { filter: brightness(1.1); }

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ íŒŒí‹° ì¢…ë£Œ ëª¨ë‹¬) */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    .modal-box {
        background: #36393f;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        max-width: 350px;
        border: 1px solid #202225;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    /* ì„¤ëª…ì°½ ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
    .desc-scroll::-webkit-scrollbar { width: 6px; }
    .desc-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    .desc-scroll::-webkit-scrollbar-track { background: transparent; }

    /* ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
    .member-item {
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        background: rgba(255,255,255,0.04); 
        padding: 10px; 
        border-radius: 8px; 
        margin-bottom: 8px;
        transition: background 0.2s;
    }
    .member-item:hover { 
        background: rgba(255,255,255,0.08); 
    }

    /* --- [ì¶”ê°€ë¨] ê°•í‡´ ì•ˆë‚´ íŒì—… ìŠ¤íƒ€ì¼ (ë””ìì¸ë§Œ ì–¹ì—ˆìŠµë‹ˆë‹¤!) --- */
    .kick-modal-overlay {
        display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85); /* ë°°ê²½ì„ ë” ì–´ë‘¡ê²Œ */
        backdrop-filter: blur(5px); /* ë°°ê²½ íë¦¼ íš¨ê³¼ */
        z-index: 9999;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease-out;
    }

    .kick-modal-box {
        background: #36393f; /* ë‹¤í¬ í…Œë§ˆ ë°°ê²½ */
        padding: 40px 30px;
        border-radius: 16px;
        width: 90%;
        max-width: 380px;
        text-align: center;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 15px 50px rgba(0,0,0,0.7);
        transform: scale(0.9);
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    .kick-btn {
        width: 100%;
        padding: 14px;
        border-radius: 10px;
        font-weight: 800;
        cursor: pointer;
        border: none;
        font-size: 16px;
        background: #ed4245; /* ğŸš¨ ê°•ë ¬í•œ ë¹¨ê°„ìƒ‰ (í‡´ì¥ ì˜ë¯¸) */
        color: white;
        transition: 0.2s;
        margin-top: 10px;
    }

    .kick-btn:hover { background: #c03537; transform: translateY(-2px); }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { to { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
</style>

<div class="party-wrapper">
    <div class="info-sidebar">
        <div style="display:flex; gap:10px; margin-bottom:12px;">
            <span style="background: var(--my-msg-bg); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                {{ party.game.name }}
            </span>
            {% if party.mic_required %}
            <span style="background: #eb4d4b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                ğŸ™ï¸ ë§ˆì´í¬ í•„ìˆ˜
            </span>
            {% endif %}
        </div>

        <h2 style="margin: 0 0 12px; color: white;">{{ party.mode }}</h2>
        
        <div class="desc-scroll" style="
            max-height: 200px; 
            overflow-y: auto; 
            padding-right: 10px; 
            margin-bottom: 20px;
        ">
            <p style="
                color: var(--text-color); 
                font-size: 14px; 
                line-height: 1.6;
                margin: 0;
                white-space: pre-wrap;
                word-break: break-all;
            ">{{ party.description|default:"íŒŒí‹° ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤." }}</p>
        </div>
        
        <hr style="border-color: rgba(255,255,255,0.1); margin: 20px 0;">

        <div style="color: var(--text-color); font-weight: bold; margin-bottom: 10px;">
            ì°¸ì—¬ ì¸ì› (<span id="member-count">{{ party.current_member_count }}</span>/{{ party.max_members }})
        </div>
        <div style="height: 8px; background: #202225; border-radius: 4px; overflow: hidden; margin-bottom: 15px;">
            <div id="progress-bar" style="height: 100%; background: #3ba55c; width: calc(({{ party.current_member_count }} / {{ party.max_members }}) * 100%); transition: 0.3s;"></div>
        </div>

        <div style="color: var(--text-color); font-weight: bold; margin-bottom: 10px;">
            ì°¸ì—¬ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸
        </div>

        <div id="member-list-container" style="flex: 1; overflow-y: auto; margin-bottom: 20px;">
            {% for member in active_members %}
            <div class="member-item">
                <span style="color: #dcddde; font-weight: 500;">
                    {{ member.user.nickname }} 
                    
                    {% if party.host == member.user %}ğŸ‘‘{% endif %}
                    
                    {% if request.user == member.user %}
                        <span style="font-size: 12px; color: #3ba55c; margin-left: 5px;">(ë‚˜)</span>
                    {% endif %}
                </span>
                
                {% if is_host and member.user != party.host %}
                <form action="{% url 'party_kick' party.id member.user.id %}" method="post" style="display:inline;" onsubmit="return confirm('ì •ë§ {{ member.user.nickname }}ë‹˜ì„ ê°•í‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    {% csrf_token %}
                    <button type="submit" style="background: none; border: none; color: #ed4245; cursor: pointer; font-size: 18px; padding: 0 5px;" title="ê°•í‡´í•˜ê¸°">Ã—</button>
                </form>
                {% endif %}
            </div>
            {% empty %}
            <div style="color: #72767d; text-align: center; padding: 20px;">ë©¤ë²„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            {% endfor %}
        </div>
        <div id="party-action-container" style="margin-top: auto;">
            {% if party.host == user %}
                <form action="{% url 'party_leave' party.id %}" method="post" onsubmit="return confirm('íŒŒí‹°ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\në‹¤ìŒ ì°¸ì—¬ìê°€ ìë™ìœ¼ë¡œ ë°©ì¥ì´ ë©ë‹ˆë‹¤.');">
                    {% csrf_token %}
                    <button type="submit" style="width: 100%; padding: 14px; background: #ed4245; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                        ğŸ‘‹ ë°©ì¥ ê¶Œí•œ ë„˜ê¸°ê³  ë‚˜ê°€ê¸°
                    </button>
                </form>
            {% elif is_member %}
                <form action="{% url 'party_leave' party.id %}" method="post" onsubmit="return confirm('ì •ë§ íŒŒí‹°ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    {% csrf_token %}
                    <button type="submit" style="width: 100%; padding: 14px; background: #4f545c; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                        ğŸ‘‹ íŒŒí‹° ë‚˜ê°€ê¸°
                    </button>
                </form>
            {% else %}
                <form action="{% url 'party_join' party.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit" style="width: 100%; padding: 14px; background: #3ba55c; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                        ğŸš€ íŒŒí‹° ì°¸ì—¬í•˜ê¸°
                    </button>
                </form>
            {% endif %}
        </div>
    </div>

    <div class="chat-main">
        <div class="chat-header">
            <span>ğŸ’¬</span>
            <span>íŒŒí‹° ì±„íŒ…ë°©</span>
        </div>

        <div id="chat-log">
            {% for msg in chat_messages %}
                <div class="message-row {% if msg.user == request.user %}mine{% else %}other{% endif %}">
                    <span class="message-sender">{{ msg.user.nickname|default:msg.user.username }}</span>
                    <div class="message-bubble">{{ msg.content }}</div>
                </div>
            {% endfor %}
            <div class="system-message">ì±„íŒ…ë°©ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        </div>

        {% if is_member %}
            <div class="chat-input-area">
                <input id="chat-message-input" class="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                <button id="chat-message-submit" class="send-btn">ì „ì†¡</button>
            </div>
        {% else %}
            <div style="padding: 20px; text-align: center; color: var(--muted-color); background: var(--header-bg);">
                íŒŒí‹°ì— ì°¸ì—¬í•´ì•¼ ì±„íŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        {% endif %}
    </div>
</div>

<div id="party-end-modal" class="modal-overlay">
    <div class="modal-box">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸš«</div>
        <h2 style="color: white; margin-bottom: 10px;">íŒŒí‹°ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h2>
        <p style="color: var(--text-color); margin-bottom: 20px;">
            ë°©ì¥ì´ íŒŒí‹°ë¥¼ í•´ì²´í–ˆìŠµë‹ˆë‹¤.<br>ë¡œë¹„ë¡œ ì´ë™í•©ë‹ˆë‹¤.
        </p>
        <button onclick="location.href='{% url 'party_list' %}'" style="background: var(--my-msg-bg); color: white; border: none; padding: 10px 24px; border-radius: 4px; cursor: pointer; font-weight: bold;">
            í™•ì¸
        </button>
    </div>
</div>

<div id="kick-modal" class="kick-modal-overlay">
    <div class="kick-modal-box">
        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ‘‹</div>
        <h3 style="color: white; margin: 0 0 10px; font-size: 24px; font-weight: 800;">ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h3>
        <p style="color: #b9bbbe; font-size: 15px; margin-bottom: 30px; line-height: 1.6;">
            ë°©ì¥ì— ì˜í•´ íŒŒí‹°ì—ì„œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
            ë‹¤ë¥¸ íŒŒí‹°ë¥¼ ì°¾ì•„ë³´ì„¸ìš”!
        </p>
        
        <button onclick="location.href='{% url 'party_list' %}'" class="kick-btn">
            ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </button>
    </div>
</div>

<script>
    // 0. CSRF í† í° ê°€ì ¸ì˜¤ëŠ” í—¬í¼ í•¨ìˆ˜
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // 1. ê¸°ë³¸ ì„¤ì •
    const partyId = "{{ party.id }}";
    const currentUserId = "{{ request.user.id }}";
    let isHost = "{{ is_host|yesno:'true,false' }}" === "true";
    let isMember = "{{ is_member|yesno:'true,false' }}" === "true";
    const partyActionContainer = document.getElementById('party-action-container');

    function renderPartyAction(isHostNow, isMemberNow) {
        if (!partyActionContainer) return;

        if (isHostNow) {
            partyActionContainer.innerHTML = `
                <form action="/parties/${partyId}/leave/" method="post" onsubmit="return confirm('íŒŒí‹°ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\\në‹¤ìŒ ì°¸ì—¬ìê°€ ìë™ìœ¼ë¡œ ë°©ì¥ì´ ë©ë‹ˆë‹¤.');">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                    <button type="submit" style="width: 100%; padding: 14px; background: #ed4245; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                        ğŸ‘‹ ë°©ì¥ ê¶Œí•œ ë„˜ê¸°ê³  ë‚˜ê°€ê¸°
                    </button>
                </form>
            `;
            return;
        }

        if (isMemberNow) {
            partyActionContainer.innerHTML = `
                <form action="/parties/${partyId}/leave/" method="post" onsubmit="return confirm('ì •ë§ íŒŒí‹°ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                    <button type="submit" style="width: 100%; padding: 14px; background: #4f545c; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                        ğŸ‘‹ íŒŒí‹° ë‚˜ê°€ê¸°
                    </button>
                </form>
            `;
            return;
        }

        partyActionContainer.innerHTML = `
            <form action="/parties/${partyId}/join/" method="post">
                <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                <button type="submit" style="width: 100%; padding: 14px; background: #3ba55c; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                    ğŸš€ íŒŒí‹° ì°¸ì—¬í•˜ê¸°
                </button>
            </form>
        `;
    }

    const chatLog = document.querySelector('#chat-log');
    chatLog.scrollTop = chatLog.scrollHeight;

    const params = new URLSearchParams(window.location.search);
    const kickedUserName = params.get('kicked_user_name');
    if (kickedUserName) {
        const sysHTML = `<div class="system-message" style="color:#ed4245;">ğŸš« ${kickedUserName}ë‹˜ì´ ê°•ì œ ì¶”ë°©ë˜ì—ˆìŠµë‹ˆë‹¤.</div>`;
        chatLog.insertAdjacentHTML('beforeend', sysHTML);
        chatLog.scrollTop = chatLog.scrollHeight;

        params.delete('kicked_user_name');
        const newQuery = params.toString();
        const newUrl = `${window.location.pathname}${newQuery ? `?${newQuery}` : ''}`;
        window.history.replaceState({}, '', newUrl);
    }

    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const chatSocket = new WebSocket(protocol + window.location.host + '/ws/chat/' + partyId + '/');

    // 2. ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        // (A) ì¼ë°˜ ì±„íŒ… ë©”ì‹œì§€
        if (data.type === 'chat_message') {
            const isMe = (String(data.sender_id) === String(currentUserId));
            const senderName = data.sender || 'ì•Œ ìˆ˜ ì—†ìŒ';
            const msgHTML = `
                <div class="message-row ${isMe ? 'mine' : 'other'}">
                    <span class="message-sender">${senderName}</span>
                    <div class="message-bubble">${data.message}</div>
                </div>
            `;
            chatLog.insertAdjacentHTML('beforeend', msgHTML);
            chatLog.scrollTop = chatLog.scrollHeight;
        } 
        // (B) ì‹œìŠ¤í…œ ë©”ì‹œì§€
        else if (data.type === 'system_message') {
            const sysHTML = `<div class="system-message">${data.message}</div>`;
            chatLog.insertAdjacentHTML('beforeend', sysHTML);
            chatLog.scrollTop = chatLog.scrollHeight;
        }
        // (C) ì¸ì›ìˆ˜ ì—…ë°ì´íŠ¸
        else if (data.type === 'count_update') {
            const countEl = document.querySelector('#member-count');
            const barEl = document.querySelector('#progress-bar');
            if (countEl) countEl.innerText = data.count;
            if (barEl) {
                const max = {{ party.max_members }};
                const pct = (data.count / max) * 100;
                barEl.style.width = pct + '%';
            }
        }
        // (D) ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        else if (data.type === 'member_list_update') {
            const listContainer = document.getElementById('member-list-container');
            if (listContainer) {
                listContainer.innerHTML = ''; 

                const me = data.members.find(member => String(member.id) === String(currentUserId));
                isMember = Boolean(me);
                isHost = Boolean(me && me.is_host);
                renderPartyAction(isHost, isMember);

                data.members.forEach(member => {
                    const isMe = (String(member.id) === String(currentUserId));
                    
                    // ê°•í‡´ ë²„íŠ¼ HTML (ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ í¼ ìƒì„±)
                    let kickButtonHtml = '';
                    if (isHost && !member.is_host) {
                        kickButtonHtml = `
                            <form action="/parties/${partyId}/members/${member.id}/kick/" method="post" style="display:inline;" onsubmit="return confirm('ì •ë§ ${member.nickname}ë‹˜ì„ ê°•í‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                                <button type="submit" style="background: none; border: none; color: #ed4245; cursor: pointer; font-size: 18px; padding: 0 5px;" title="ê°•í‡´í•˜ê¸°">Ã—</button>
                            </form>
                        `;
                    }

                    let html = `
                    <div class="member-item">
                        <span style="color: #dcddde; font-weight: 500;">
                            ${member.nickname}
                            ${member.is_host ? 'ğŸ‘‘' : ''}
                            ${isMe ? '<span style="font-size: 12px; color: #3ba55c; margin-left: 5px;">(ë‚˜)</span>' : ''}
                        </span>
                        ${kickButtonHtml}
                    </div>`;
                    
                    listContainer.insertAdjacentHTML('beforeend', html);
                });
            }
        }
        // âœ… (E) ê°•í‡´ ì‹ í˜¸ ì²˜ë¦¬ (ì—¬ê¸°ë§Œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤!)
        else if (data.type === 'user_kicked') {
            // ë‚´ê°€ ê°•í‡´ë‹¹í•œ ê²½ìš°
            if (String(data.kicked_user_id) === String(currentUserId)) {
                // ê¸°ì¡´ alert ëŒ€ì‹  ì˜ˆìœ ëª¨ë‹¬ ë„ìš°ê¸°
                const modal = document.getElementById('kick-modal');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // ë’·ë°°ê²½ ìŠ¤í¬ë¡¤ ë§‰ê¸°
            } 
            // ë‹¤ë¥¸ ì‚¬ëŒì´ ê°•í‡´ë‹¹í•œ ê²½ìš°
            else {
                const sysHTML = `<div class="system-message" style="color:#ed4245;">ğŸš« ${data.kicked_user_name}ë‹˜ì´ ê°•ì œ ì¶”ë°©ë˜ì—ˆìŠµë‹ˆë‹¤.</div>`;
                chatLog.insertAdjacentHTML('beforeend', sysHTML);
                chatLog.scrollTop = chatLog.scrollHeight;
            }
        }
        // (F) íŒŒí‹° í•´ì²´ ì²˜ë¦¬
        else if (data.type === 'party_killed') {
            if (!isHost) {
                document.getElementById('party-end-modal').style.display = 'flex';
            }
        }
    };

    chatSocket.onclose = function(e) { console.error('Socket closed'); };

    document.addEventListener('submit', async function (e) {
        const form = e.target;
        if (!(form instanceof HTMLFormElement)) return;
        if (!form.action.includes('/kick/')) return;

        e.preventDefault();

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            });

            if (!response.ok) {
                console.error('ê°•í‡´ ìš”ì²­ ì‹¤íŒ¨:', response.status);
            }
        } catch (err) {
            console.error('ê°•í‡´ ìš”ì²­ ì¤‘ ì˜¤ë¥˜:', err);
        }
    });

    // 3. ì±„íŒ… ì…ë ¥
    const inputDom = document.querySelector('#chat-message-input');
    const submitBtn = document.querySelector('#chat-message-submit');

    if (inputDom && submitBtn) {
        inputDom.focus();
        inputDom.onkeyup = function(e) { if (e.keyCode === 13) submitBtn.click(); };
        submitBtn.onclick = function(e) {
            const message = inputDom.value;
            if (message.trim() !== "") {
                chatSocket.send(JSON.stringify({'message': message}));
                inputDom.value = '';
            }
        };
    }
</script>
{% endblock %}