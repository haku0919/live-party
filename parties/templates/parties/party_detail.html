{% extends "core/base.html" %}
{% load static %}

{% block content %}
<style>
    /* --- [1. ë ˆì´ì•„ì›ƒ & ë””ìì¸] --- */
    :root {
        --chat-bg: #36393f;        /* ì±„íŒ… ë°°ê²½ */
        --sidebar-bg: #2f3136;     /* ì‚¬ì´ë“œë°” ë°°ê²½ */
        --header-bg: #202225;      /* í—¤ë”/ì…ë ¥ì°½ ë°°ê²½ */
        --my-msg-bg: #5865F2;      /* ë‚´ ë©”ì‹œì§€ (íŒŒë€ìƒ‰) */
        --other-msg-bg: #40444b;   /* ìƒëŒ€ ë©”ì‹œì§€ (íšŒìƒ‰) */
        --text-color: #dcddde;     /* ê¸°ë³¸ í…ìŠ¤íŠ¸ */
        --muted-color: #72767d;    /* íë¦° í…ìŠ¤íŠ¸ */
    }

    .party-wrapper {
        display: flex;
        height: 85vh;
        max-width: 1200px;
        margin: 0 auto;
        gap: 16px;
        padding: 20px;
        box-sizing: border-box;
    }

    /* ì¢Œì¸¡ ì •ë³´ íŒ¨ë„ */
    .info-sidebar {
        flex: 1;
        background: var(--sidebar-bg);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        min-width: 300px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* ìš°ì¸¡ ì±„íŒ… íŒ¨ë„ */
    .chat-main {
        flex: 2.5;
        background: var(--chat-bg);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .chat-header {
        padding: 16px;
        background: var(--header-bg);
        border-bottom: 1px solid rgba(0,0,0,0.2);
        font-weight: bold;
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #chat-log {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    #chat-log::-webkit-scrollbar { width: 8px; }
    #chat-log::-webkit-scrollbar-thumb { background: #202225; border-radius: 4px; }

    .message-row { display: flex; flex-direction: column; }
    .message-row.mine { align-items: flex-end; }
    .message-row.other { align-items: flex-start; }

    .message-sender {
        font-size: 12px;
        color: var(--muted-color);
        margin-bottom: 4px;
        margin-left: 4px;
    }
    .message-bubble {
        padding: 10px 14px;
        border-radius: 8px;
        color: white;
        max-width: 70%;
        word-wrap: break-word;
        font-size: 15px;
        line-height: 1.4;
    }
    .mine .message-bubble { background: var(--my-msg-bg); border-bottom-right-radius: 0; }
    .other .message-bubble { background: var(--other-msg-bg); border-bottom-left-radius: 0; }

    .system-message {
        align-self: center;
        background: rgba(255, 255, 255, 0.05);
        color: var(--muted-color);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        margin: 10px 0;
    }

    .chat-input-area {
        padding: 20px;
        background: var(--header-bg);
        display: flex;
        gap: 10px;
    }
    .chat-input {
        flex: 1;
        background: #40444b;
        border: none;
        padding: 12px;
        border-radius: 8px;
        color: white;
        font-size: 15px;
    }
    .chat-input:focus { outline: none; background: #4f545c; }
    .send-btn {
        background: var(--my-msg-bg);
        color: white;
        border: none;
        padding: 0 24px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
    }
    .send-btn:hover { filter: brightness(1.1); }

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    .modal-box {
        background: #36393f;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        max-width: 350px;
        border: 1px solid #202225;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
</style>

<div class="party-wrapper">
    <div class="info-sidebar">
        <div style="margin-bottom: auto;">
            <span style="background: var(--my-msg-bg); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                {{ party.game.name }}
            </span>
            <h2 style="margin: 12px 0; color: white;">{{ party.title }}</h2>
            <p style="color: var(--text-color); font-size: 14px; line-height: 1.5;">
                {{ party.description|default:"íŒŒí‹° ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤." }}
            </p>
            
            <hr style="border-color: rgba(255,255,255,0.1); margin: 20px 0;">

            <div style="color: var(--text-color); font-weight: bold; margin-bottom: 10px;">
                ì°¸ì—¬ ì¸ì› (<span id="member-count">{{ party.current_member_count }}</span>/{{ party.max_members }})
            </div>
            <div style="height: 8px; background: #202225; border-radius: 4px; overflow: hidden;">
                <div id="progress-bar" style="height: 100%; background: #3ba55c; width: calc(({{ party.current_member_count }} / {{ party.max_members }}) * 100%); transition: 0.3s;"></div>
            </div>
        </div>

        <div style="margin-top: 20px;">
            {% if party.host == user %}
                <form action="{% url 'party_leave' party.id %}" method="post" onsubmit="return confirm('ì •ë§ íŒŒí‹°ë¥¼ í•´ì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
                    {% csrf_token %}
                    <button type="submit" style="width: 100%; padding: 14px; background: #ed4245; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                        ğŸ’¥ íŒŒí‹° í•´ì²´í•˜ê¸°
                    </button>
                </form>
            {% elif is_member %}
                <form action="{% url 'party_leave' party.id %}" method="post" onsubmit="return confirm('ì •ë§ íŒŒí‹°ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    {% csrf_token %}
                    <button type="submit" style="width: 100%; padding: 14px; background: #4f545c; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                        ğŸ‘‹ íŒŒí‹° ë‚˜ê°€ê¸°
                    </button>
                </form>
            {% else %}
                <form action="{% url 'party_join' party.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit" style="width: 100%; padding: 14px; background: #3ba55c; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                        ğŸš€ íŒŒí‹° ì°¸ì—¬í•˜ê¸°
                    </button>
                </form>
            {% endif %}
        </div>
    </div>

    <div class="chat-main">
        <div class="chat-header">
            <span>ğŸ’¬</span>
            <span>íŒŒí‹° ì±„íŒ…ë°©</span>
        </div>

        <div id="chat-log">
            <div class="system-message">ì±„íŒ…ë°©ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        </div>

        {% if is_member %}
            <div class="chat-input-area">
                <input id="chat-message-input" class="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                <button id="chat-message-submit" class="send-btn">ì „ì†¡</button>
            </div>
        {% else %}
            <div style="padding: 20px; text-align: center; color: var(--muted-color); background: var(--header-bg);">
                íŒŒí‹°ì— ì°¸ì—¬í•´ì•¼ ì±„íŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        {% endif %}
    </div>
</div>

<div id="party-end-modal" class="modal-overlay">
    <div class="modal-box">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸš«</div>
        <h2 style="color: white; margin-bottom: 10px;">íŒŒí‹°ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h2>
        <p style="color: var(--text-color); margin-bottom: 20px;">
            ë°©ì¥ì´ íŒŒí‹°ë¥¼ í•´ì²´í–ˆìŠµë‹ˆë‹¤.<br>ë¡œë¹„ë¡œ ì´ë™í•©ë‹ˆë‹¤.
        </p>
        <button onclick="location.href='{% url 'party_list' %}'" style="background: var(--my-msg-bg); color: white; border: none; padding: 10px 24px; border-radius: 4px; cursor: pointer; font-weight: bold;">
            í™•ì¸
        </button>
    </div>
</div>

<script>
    const partyId = "{{ party.id }}";
    const currentUserId = "{{ request.user.id }}";
    const isHost = "{{ is_host|yesno:'true,false' }}" === "true";

    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const chatSocket = new WebSocket(protocol + window.location.host + '/ws/chat/' + partyId + '/');

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const chatLog = document.querySelector('#chat-log');

        if (data.type === 'chat_message') {
            const isMe = (String(data.sender_id) === String(currentUserId));
            const senderName = data.sender || 'ì•Œ ìˆ˜ ì—†ìŒ';
            const msgHTML = `
                <div class="message-row ${isMe ? 'mine' : 'other'}">
                    <span class="message-sender">${senderName}</span>
                    <div class="message-bubble">${data.message}</div>
                </div>
            `;
            chatLog.insertAdjacentHTML('beforeend', msgHTML);
        } 
        else if (data.type === 'system_message') {
            const sysHTML = `<div class="system-message">${data.message}</div>`;
            chatLog.insertAdjacentHTML('beforeend', sysHTML);
        }
        else if (data.type === 'count_update') {
            const countEl = document.querySelector('#member-count');
            const barEl = document.querySelector('#progress-bar');
            if (countEl) countEl.innerText = data.count;
            if (barEl) {
                const max = {{ party.max_members }};
                const pct = (data.count / max) * 100;
                barEl.style.width = pct + '%';
            }
        }
        else if (data.type === 'party_killed') {
            if (!isHost) {
                document.getElementById('party-end-modal').style.display = 'flex';
            }
        }
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = function(e) { console.error('Socket closed'); };

    const inputDom = document.querySelector('#chat-message-input');
    const submitBtn = document.querySelector('#chat-message-submit');

    if (inputDom && submitBtn) {
        inputDom.focus();
        inputDom.onkeyup = function(e) { if (e.keyCode === 13) submitBtn.click(); };
        submitBtn.onclick = function(e) {
            const message = inputDom.value;
            if (message.trim() !== "") {
                chatSocket.send(JSON.stringify({'message': message}));
                inputDom.value = '';
            }
        };
    }
</script>
{% endblock %}