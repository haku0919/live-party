{% extends "parties/base.html" %}

{% block title %}{{ party.game.name }} Â· {{ party.mode }}{% endblock %}

{% block content %}
<style>
  .party-layout {
    display: grid;
    grid-template-columns: minmax(300px, 350px) minmax(0, 1fr);
    gap: 16px;
    align-items: start;
  }

  .sidebar {
    position: sticky;
    top: 92px;
    max-height: calc(100vh - 114px);
    overflow: auto;
    scrollbar-gutter: stable;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .summary-row {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .room-title {
    font-size: 1.45rem;
    margin: 0;
  }

  .desc-box {
    margin: 0;
    color: var(--muted);
    line-height: 1.55;
    white-space: pre-wrap;
    max-height: 140px;
    overflow: auto;
    padding-right: 4px;
  }

  .meter {
    width: 100%;
    height: 8px;
    border-radius: 999px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.08);
  }

  .meter > div {
    height: 100%;
    background: linear-gradient(120deg, var(--brand), var(--ok));
    transition: width 180ms ease;
  }

  #member-list-container {
    overflow: auto;
    max-height: 250px;
  }

  .member-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--line);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.02);
    padding: 10px;
    margin-bottom: 8px;
  }

  .member-actions {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .icon-btn {
    border: 1px solid var(--line);
    background: rgba(255, 255, 255, 0.03);
    color: var(--text);
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    padding: 4px 7px;
  }

  .icon-btn.warn {
    color: #ff9090;
    border-color: rgba(255, 120, 120, 0.35);
  }

  .request-panel {
    border: 1px solid var(--line);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    padding: 10px;
    display: none;
  }

  .request-item {
    border: 1px solid var(--line);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.02);
    padding: 8px;
    margin-top: 8px;
  }

  .request-actions {
    display: flex;
    gap: 6px;
    margin-top: 8px;
  }

  .request-actions form { margin: 0; flex: 1; }
  .request-actions button { width: 100%; }

  .settings-panel .input,
  .settings-panel textarea {
    margin-top: 6px;
  }

  .settings-panel .field {
    margin-top: 10px;
  }

  .waitlist-list {
    margin-top: 8px;
    max-height: 130px;
    overflow: auto;
  }

  .wait-item {
    padding: 6px 8px;
    border: 1px solid var(--line);
    border-radius: 8px;
    margin-bottom: 6px;
    font-size: .83rem;
    color: var(--muted);
  }

  .chat-wrap {
    position: sticky;
    top: 92px;
    min-height: calc(100vh - 114px);
    max-height: calc(100vh - 114px);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .chat-head {
    border-bottom: 1px solid var(--line);
    padding: 14px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .chat-head-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .mention-filter.active {
    border-color: rgba(47, 199, 179, 0.45);
    color: #7bf0e2;
  }

  .pinned-notice {
    margin: 12px 16px 0;
    border: 1px solid rgba(47, 199, 179, 0.35);
    background: rgba(47, 199, 179, 0.08);
    border-radius: 12px;
    padding: 10px 12px;
  }

  .pinned-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    font-size: .83rem;
    color: #9deee3;
  }

  .pinned-content {
    margin: 8px 0 0;
    font-size: .9rem;
    line-height: 1.45;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .pinned-meta {
    margin: 6px 0 0;
    color: var(--muted);
    font-size: .76rem;
  }

  .chat-log {
    flex: 1;
    min-height: 180px;
    overflow: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 11px;
  }

  .message-row { display: flex; flex-direction: column; gap: 4px; }
  .message-row.mine { align-items: flex-end; }
  .message-row.other { align-items: flex-start; }

  .message-sender {
    font-size: 0.75rem;
    color: var(--muted);
  }

  .message-content {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  .mine .message-content {
    align-items: flex-end;
  }

  .message-bubble {
    max-width: min(75%, 550px);
    min-width: 2.4em;
    padding: 9px 12px;
    border-radius: 12px;
    line-height: 1.45;
    white-space: pre-wrap;
    word-break: keep-all;
    overflow-wrap: break-word;
  }

  .mine .message-bubble {
    background: linear-gradient(140deg, rgba(47, 199, 179, 0.9), rgba(31, 139, 216, 0.9));
    color: #04141a;
    border-bottom-right-radius: 4px;
    font-weight: 600;
  }

  .other .message-bubble {
    border: 1px solid var(--line);
    background: rgba(255, 255, 255, 0.05);
    border-bottom-left-radius: 4px;
  }

  .message-row.mention-me .message-bubble {
    border-color: rgba(47, 199, 179, 0.55);
    box-shadow: 0 0 0 1px rgba(47, 199, 179, 0.35) inset;
  }

  .system-message {
    align-self: center;
    font-size: 0.76rem;
    color: var(--muted);
    border: 1px solid var(--line);
    background: rgba(255, 255, 255, 0.03);
    border-radius: 999px;
    padding: 4px 10px;
  }

  .chat-input-area {
    border-top: 1px solid var(--line);
    padding: 12px;
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }

  .mention-input-wrap {
    position: relative;
    flex: 1;
  }

  .chat-input-area input { width: 100%; }

  .mention-suggest {
    position: absolute;
    left: 0;
    right: 0;
    bottom: calc(100% + 6px);
    border: 1px solid var(--line);
    border-radius: 10px;
    background: var(--surface-strong);
    max-height: 180px;
    overflow: auto;
    z-index: 12;
  }

  .mention-option {
    width: 100%;
    text-align: left;
    border: 0;
    background: transparent;
    color: var(--text);
    padding: 8px 10px;
    cursor: pointer;
    font-size: .83rem;
  }

  .mention-option.active,
  .mention-option:hover {
    background: rgba(255, 255, 255, 0.08);
  }

  .pin-trigger {
    border: 1px solid var(--line);
    background: rgba(255, 255, 255, 0.05);
    color: var(--muted);
    border-radius: 8px;
    font-size: .72rem;
    padding: 4px 7px;
    cursor: pointer;
    white-space: nowrap;
  }

  .overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 95;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.76);
  }

  .overlay-card {
    width: min(92%, 380px);
    border-radius: var(--radius);
    border: 1px solid var(--line);
    background: var(--surface-strong);
    text-align: center;
    padding: 22px;
  }

  @media (max-width: 1080px) {
    .party-layout {
      grid-template-columns: 1fr;
      min-height: auto;
    }

    .sidebar,
    .chat-wrap {
      position: static;
      top: auto;
      max-height: none;
      min-height: 0;
    }

    #member-list-container { max-height: 200px; }
  }
</style>

<section class="party-layout">
  <aside class="card sidebar">
    <div class="summary-row">
      <span class="badge">{{ party.game.name }}</span>
      <span id="join-policy-badge" class="badge" {% if party.join_policy != 'APPROVAL' %}style="display:none"{% endif %}>ìŠ¹ì¸ì œ</span>
      <span id="mic-badge" class="badge" style="{% if not party.mic_required %}display:none;{% endif %}border-color:rgba(255,123,98,.45);color:#ffaf9f;">ë§ˆì´í¬ í•„ìˆ˜</span>
      <span class="badge" id="party-status">{{ party.get_status_display }}</span>
    </div>

    <h1 class="room-title" id="party-mode-label">{{ party.mode }}</h1>
    <p class="desc-box" id="party-desc-label">{{ party.description|default:"íŒŒí‹° ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤." }}</p>

    <div class="summary-row" style="justify-content:space-between;">
      <strong>ì¸ì› <span id="member-count">{{ party.current_member_count }}</span> / <span id="max-members">{{ party.max_members }}</span></strong>
      <button id="copy-invite" type="button" class="btn btn-ghost">ì´ˆëŒ€ ë§í¬ ë³µì‚¬</button>
    </div>

    <div class="meter">
      <div id="progress-bar" style="width: {% widthratio party.current_member_count party.max_members 100 %}%;"></div>
    </div>
    <p id="member-progress-percent" style="margin:6px 0 0;color:var(--muted);font-size:.78rem;">
      {% widthratio party.current_member_count party.max_members 100 %}%
    </p>

    <div id="request-panel" class="request-panel" style="{% if is_host and party.join_policy == 'APPROVAL' %}display:block;{% endif %}">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>ì°¸ê°€ ì‹ ì²­</strong>
        <span class="badge" id="pending-request-count">{{ pending_requests|length }}ê±´</span>
      </div>
      <div id="request-list">
        {% for req in pending_requests %}
          <div class="request-item" id="join-request-{{ req.id }}">
            <div style="font-size:.92rem;">{{ req.user.nickname|default:req.user.username }}</div>
            <div class="request-actions">
              <form action="{% url 'party_join_request_approve' party.id req.id %}" method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-solid">ìˆ˜ë½</button>
              </form>
              <form action="{% url 'party_join_request_reject' party.id req.id %}" method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-ghost">ê±°ì ˆ</button>
              </form>
            </div>
          </div>
        {% empty %}
          <p id="request-empty" style="color:var(--muted);font-size:.84rem;margin:8px 0 0;">ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
      </div>
    </div>

    {% if is_host %}
    <div class="request-panel settings-panel" style="display:block;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>íŒŒí‹° ì„¤ì •</strong>
        <span class="badge">í˜¸ìŠ¤íŠ¸ ì „ìš©</span>
      </div>
      <form id="party-settings-form" action="{% url 'party_settings_update' party.id %}" method="post">
        {% csrf_token %}
        <div class="field">
          <label for="settings-mode" style="font-size:.82rem;color:var(--muted);">ëª¨ë“œ</label>
          <input id="settings-mode" class="input" type="text" name="mode" maxlength="50" value="{{ party.mode }}">
        </div>
        <div class="field">
          <label for="settings-description" style="font-size:.82rem;color:var(--muted);">ì„¤ëª…</label>
          <textarea id="settings-description" class="input" name="description" rows="3">{{ party.description }}</textarea>
        </div>
        <div class="field">
          <label for="settings-max-members" style="font-size:.82rem;color:var(--muted);">ìµœëŒ€ ì¸ì›</label>
          <input id="settings-max-members" class="input" type="number" name="max_members" min="2" max="20" value="{{ party.max_members }}">
        </div>
        <label class="field" style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input id="settings-mic-required" type="checkbox" name="mic_required" {% if party.mic_required %}checked{% endif %}>
          <span style="font-size:.82rem;color:var(--muted);">ë§ˆì´í¬ í•„ìˆ˜</span>
        </label>
        <button type="submit" class="btn btn-solid" style="width:100%;margin-top:8px;">ì„¤ì • ì €ì¥</button>
      </form>
    </div>
    {% endif %}

    <div class="request-panel" style="display:block;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>ëŒ€ê¸°ì—´</strong>
        <span class="badge" id="waitlist-count">{{ waitlist_count }}ëª…</span>
      </div>
      <p id="my-waitlist-rank" style="margin:8px 0 0;color:var(--muted);font-size:.84rem;">
        {% if my_waitlist_rank %}ë‚´ ëŒ€ê¸° ìˆœë²ˆ: {{ my_waitlist_rank }}ë²ˆ{% else %}ë‚´ ëŒ€ê¸° ìƒíƒœ: ë¯¸ë“±ë¡{% endif %}
      </p>
      <div class="waitlist-list" id="waitlist-list">
        {% for item in waitlist_entries %}
          <div class="wait-item" data-user-id="{{ item.user.id }}">{{ forloop.counter }}. {{ item.user.nickname|default:item.user.username }}</div>
        {% empty %}
          <p id="waitlist-empty" style="margin:8px 0 0;color:var(--muted);font-size:.84rem;">ëŒ€ê¸°ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
      </div>
    </div>

    <div>
      <strong style="display:block;margin-bottom:8px;">ì°¸ì—¬ ë©¤ë²„</strong>
      <div id="member-list-container">
        {% for member in active_members %}
          <div class="member-item">
            <span>
              {{ member.user.nickname|default:member.user.username }}
              {% if party.host == member.user %}ğŸ‘‘{% endif %}
              {% if request.user == member.user %}<span style="color:var(--ok);font-size:.8rem;">(ë‚˜)</span>{% endif %}
            </span>
            {% if is_host and member.user != party.host %}
              <div class="member-actions">
                <button type="button" class="icon-btn transfer-trigger" data-user-id="{{ member.user.id }}" data-user-name="{{ member.user.nickname|default:member.user.username }}">ìœ„ì„</button>
                <form action="{% url 'party_kick' party.id member.user.id %}" method="post" onsubmit="return confirm('ì •ë§ {{ member.user.nickname|default:member.user.username }}ë‹˜ì„ ê°•í‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                  {% csrf_token %}
                  <button type="submit" class="icon-btn warn">ê°•í‡´</button>
                </form>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>

    <div id="party-action-container">
      {% if party.host == user %}
        <form action="{% url 'party_leave' party.id %}" method="post" onsubmit="return confirm('íŒŒí‹°ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\në‹¤ìŒ ì°¸ì—¬ìì—ê²Œ ë°©ì¥ ê¶Œí•œì´ ìœ„ì„ë©ë‹ˆë‹¤.');">
          {% csrf_token %}
          <button type="submit" class="btn" style="width:100%;background:#ff5c5c;border-color:#ff5c5c;">ë°©ì¥ ê¶Œí•œ ë„˜ê¸°ê³  ë‚˜ê°€ê¸°</button>
        </form>
      {% elif is_member %}
        <form action="{% url 'party_leave' party.id %}" method="post" onsubmit="return confirm('ì •ë§ íŒŒí‹°ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?');">
          {% csrf_token %}
          <button type="submit" class="btn btn-ghost" style="width:100%;">íŒŒí‹° ë‚˜ê°€ê¸°</button>
        </form>
      {% elif party.join_policy == 'APPROVAL' and my_join_request_status == 'PENDING' %}
        <form action="{% url 'party_join_request_cancel' party.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn btn-ghost" style="width:100%;">ì‹ ì²­ ì·¨ì†Œ</button>
        </form>
      {% elif my_waitlist_rank %}
        <button type="button" class="btn btn-ghost" style="width:100%;cursor:not-allowed;" disabled>ëŒ€ê¸°ì—´ {{ my_waitlist_rank }}ë²ˆ</button>
      {% elif party.join_policy == 'APPROVAL' %}
        <form action="{% url 'party_join' party.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn btn-solid" style="width:100%;">ì°¸ê°€ ì‹ ì²­í•˜ê¸°</button>
        </form>
      {% elif my_waitlist_rank %}
        <button type="button" class="btn btn-ghost" style="width:100%;cursor:not-allowed;" disabled>ëŒ€ê¸°ì—´ {{ my_waitlist_rank }}ë²ˆ</button>
      {% elif party.status == 'FULL' %}
        <form action="{% url 'party_join' party.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn btn-solid" style="width:100%;">ëŒ€ê¸°ì—´ ì°¸ê°€</button>
        </form>
      {% else %}
        <form action="{% url 'party_join' party.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn btn-solid" style="width:100%;">íŒŒí‹° ì°¸ì—¬í•˜ê¸°</button>
        </form>
      {% endif %}
    </div>
  </aside>

  <section class="card chat-wrap">
    <header class="chat-head">
      <strong>íŒŒí‹° ì±„íŒ…ë°©</strong>
      <div class="chat-head-right">
        <button id="mention-filter-toggle" type="button" class="btn btn-ghost mention-filter">ë©˜ì…˜ë§Œ ë³´ê¸°</button>
        <span class="badge" id="message-count">ë©”ì‹œì§€ {{ chat_messages|length }}ê°œ</span>
      </div>
    </header>

    <div id="pinned-notice" class="pinned-notice" {% if not pinned_notice %}style="display:none;"{% endif %}>
      <div class="pinned-title">
        <strong>ğŸ“Œ ê³ ì • ê³µì§€</strong>
        <button id="pinned-clear-btn" type="button" class="btn btn-ghost" style="padding:4px 8px;font-size:.72rem;{% if not is_host %}display:none;{% endif %}">ê³µì§€ í•´ì œ</button>
      </div>
      <p id="pinned-content" class="pinned-content">{% if pinned_notice %}{{ pinned_notice.content }}{% endif %}</p>
      <p id="pinned-meta" class="pinned-meta">{% if pinned_notice %}ì‘ì„±ì: {{ pinned_notice.sender }}{% endif %}</p>
    </div>

    <div id="chat-log" class="chat-log">
      {% for msg in chat_messages %}
        <div class="message-row {% if msg.user == request.user %}mine{% else %}other{% endif %}" data-chat-message="1" data-message-id="{{ msg.id }}">
          <span class="message-sender">{{ msg.sender_name|default:msg.user.nickname|default:msg.user.username|default:"ì‹œìŠ¤í…œ" }}</span>
          <div class="message-content">
            <div class="message-bubble">{{ msg.content|cut:"\r"|cut:"\n" }}</div>
            {% if is_host and msg.user %}
              <button type="button" class="pin-trigger" data-message-id="{{ msg.id }}">ê³µì§€ ê³ ì •</button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
      <div class="system-message">ì±„íŒ…ë°©ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
    </div>

    {% if is_member %}
      <div class="chat-input-area">
        <div class="mention-input-wrap">
          <input id="chat-message-input" class="input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (Enter ì „ì†¡)">
          <div id="mention-suggest" class="mention-suggest" style="display:none;"></div>
        </div>
        <button id="chat-message-submit" class="btn btn-solid" type="button">ì „ì†¡</button>
      </div>
    {% else %}
      <div style="padding:16px;color:var(--muted);text-align:center;">íŒŒí‹° ì°¸ì—¬ìë§Œ ì±„íŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    {% endif %}
  </section>
</section>

<div id="host-transfer-modal" class="overlay">
  <div class="overlay-card">
    <h3 style="margin:0 0 8px;">ë°©ì¥ì„ ë„˜ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
    <p id="host-transfer-message" style="margin:0 0 16px;color:var(--muted);"></p>
    <form id="host-transfer-form" method="post">
      {% csrf_token %}
      <button type="submit" class="btn btn-solid" style="width:100%;margin-bottom:8px;">ìœ„ì„ í™•ì •</button>
      <button type="button" class="btn btn-ghost" style="width:100%;" onclick="closeTransferModal()">ì·¨ì†Œ</button>
    </form>
  </div>
</div>

<div id="party-end-modal" class="overlay">
  <div class="overlay-card">
    <h2 style="margin:0 0 10px;">íŒŒí‹°ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h2>
    <p style="color:var(--muted);margin:0 0 16px;">ë°©ì¥ì´ íŒŒí‹°ë¥¼ í•´ì²´í–ˆìŠµë‹ˆë‹¤. ëª©ë¡ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
    <button onclick="location.href='{% url 'party_list' %}'" class="btn btn-solid" type="button">í™•ì¸</button>
  </div>
</div>

<div id="kick-modal" class="overlay">
  <div class="overlay-card">
    <h2 style="margin:0 0 10px;">ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h2>
    <p style="color:var(--muted);margin:0 0 16px;">ë°©ì¥ì— ì˜í•´ íŒŒí‹°ì—ì„œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
    <button onclick="location.href='{% url 'party_list' %}'" class="btn btn-solid" type="button">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text == null ? '' : String(text);
    return div.innerHTML;
  }

  const csrftoken = getCookie('csrftoken') || '';
  const partyId = "{{ party.id }}";
  const currentUserId = "{{ request.user.id }}";
  const joinPolicy = "{{ party.join_policy }}";
  const defaultTitle = document.title;
  const currentUserNickname = "{{ request.user.nickname|default:''|escapejs }}";
  const currentUsername = "{{ request.user.username|escapejs }}";
  const mentionAliases = [currentUserNickname, currentUsername].filter(Boolean).map(v => v.toLowerCase());
  const mentionNames = new Set([
    {% for member in active_members %}
      "{{ member.user.nickname|default:member.user.username|escapejs }}",
    {% endfor %}
  ]);

  let isHost = "{{ is_host|yesno:'true,false' }}" === 'true';
  let isMember = "{{ is_member|yesno:'true,false' }}" === 'true';
  let myJoinRequestStatus = "{{ my_join_request_status }}";
  let myWaitlistRank = Number("{{ my_waitlist_rank|default:0 }}") || 0;
  let currentCount = Number("{{ party.current_member_count }}");
  let maxMembers = Number("{{ party.max_members }}");
  let hiddenMessageCount = 0;
  let hiddenMentionCount = 0;
  let mentionFilterOnly = false;
  let mentionState = null;
  let mentionActiveIndex = -1;
  let mentionCandidates = [];
  let isTextComposing = false;
  let ignoreEnterUntil = 0;
  let lastSendAt = 0;
  let suppressEnterKeyup = false;

  const chatLog = document.getElementById('chat-log');
  const partyActionContainer = document.getElementById('party-action-container');
  const messageCountEl = document.getElementById('message-count');
  const mentionFilterBtn = document.getElementById('mention-filter-toggle');
  const mentionSuggest = document.getElementById('mention-suggest');
  const requestPanel = document.getElementById('request-panel');
  const requestList = document.getElementById('request-list');
  const pendingRequestCount = document.getElementById('pending-request-count');
  const waitlistCountEl = document.getElementById('waitlist-count');
  const myWaitlistRankEl = document.getElementById('my-waitlist-rank');
  const waitlistListEl = document.getElementById('waitlist-list');
  const pinnedNoticeEl = document.getElementById('pinned-notice');
  const pinnedContentEl = document.getElementById('pinned-content');
  const pinnedMetaEl = document.getElementById('pinned-meta');
  const pinnedClearBtn = document.getElementById('pinned-clear-btn');

  function isImeComposing(e) {
    return isTextComposing || (e && (e.isComposing || e.keyCode === 229));
  }

  function parseFiniteNumber(value, fallback) {
    const n = Number(value);
    return Number.isFinite(n) ? n : fallback;
  }

  function progressWidthValue(count, max) {
    const safeCount = parseFiniteNumber(count, 0);
    const safeMax = parseFiniteNumber(max, 0);
    if (safeMax <= 0 || safeCount <= 0) return '0%';
    const pct = (safeCount / safeMax) * 100;
    // 1ëª…ì´ì–´ë„ barê°€ ë³´ì´ë„ë¡ ìµœì†Œ í­ì„ ë³´ì¥
    return `${Math.max(12, Math.min(100, pct))}%`;
  }

  function syncProgressBar(countOverride, maxOverride) {
    const countEl = document.getElementById('member-count');
    const maxEl = document.getElementById('max-members');
    const barEl = document.getElementById('progress-bar');
    const percentEl = document.getElementById('member-progress-percent');

    currentCount = parseFiniteNumber(
      countOverride,
      parseFiniteNumber(countEl ? countEl.textContent : currentCount, currentCount),
    );
    maxMembers = parseFiniteNumber(
      maxOverride,
      parseFiniteNumber(maxEl ? maxEl.textContent : maxMembers, maxMembers),
    );

    if (countEl) countEl.textContent = currentCount;
    if (maxEl) maxEl.textContent = maxMembers;

    if (barEl) {
      barEl.style.width = progressWidthValue(currentCount, maxMembers);
      barEl.style.minWidth = currentCount > 0 ? '10px' : '0';
    }
    if (percentEl) {
      const pct = maxMembers > 0 ? Math.round((currentCount / maxMembers) * 100) : 0;
      percentEl.textContent = `${Math.max(0, Math.min(100, pct))}%`;
    }
  }

  function updateMessageCount() {
    const count = chatLog.querySelectorAll('.message-row').length;
    if (messageCountEl) messageCountEl.textContent = `ë©”ì‹œì§€ ${count}ê°œ`;
  }

  function appendSystemMessage(message, color) {
    const el = document.createElement('div');
    el.className = 'system-message';
    el.textContent = message;
    if (color) el.style.color = color;
    chatLog.appendChild(el);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function containsMentionForMe(message) {
    if (!message) return false;
    return mentionAliases.some(alias => message.toLowerCase().includes(`@${alias}`));
  }

  function updateHiddenTitle() {
    if (hiddenMentionCount > 0) {
      document.title = `(@${hiddenMentionCount}) ${defaultTitle}`;
      return;
    }
    if (hiddenMessageCount > 0) {
      document.title = `(${hiddenMessageCount}) ${defaultTitle}`;
      return;
    }
    document.title = defaultTitle;
  }

  function applyMentionFilter() {
    const rows = chatLog.querySelectorAll('.message-row');
    rows.forEach(row => {
      if (!mentionFilterOnly) {
        row.style.display = '';
        return;
      }
      row.style.display = row.classList.contains('mention-me') ? '' : 'none';
    });
    if (mentionFilterBtn) {
      mentionFilterBtn.classList.toggle('active', mentionFilterOnly);
      mentionFilterBtn.textContent = mentionFilterOnly ? 'ë©˜ì…˜ë§Œ ë³´ëŠ” ì¤‘' : 'ë©˜ì…˜ë§Œ ë³´ê¸°';
    }
  }

  function decorateExistingMentions() {
    chatLog.querySelectorAll('.message-row[data-chat-message="1"]').forEach(row => {
      const bubble = row.querySelector('.message-bubble');
      if (bubble && containsMentionForMe(bubble.textContent || '')) {
        row.classList.add('mention-me');
      }
    });
    applyMentionFilter();
  }

  function appendChatMessage({ messageId, sender, senderId, message, mentionUserIds }) {
    const row = document.createElement('div');
    row.className = `message-row ${String(senderId) === String(currentUserId) ? 'mine' : 'other'}`;
    row.dataset.chatMessage = '1';
    if (messageId) row.dataset.messageId = String(messageId);

    const senderEl = document.createElement('span');
    senderEl.className = 'message-sender';
    senderEl.textContent = sender || 'ì•Œ ìˆ˜ ì—†ìŒ';

    const contentWrap = document.createElement('div');
    contentWrap.className = 'message-content';

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.textContent = (message || '').replace(/\r?\n/g, '');

    contentWrap.appendChild(bubble);
    if (isHost && messageId) {
      const pinBtn = document.createElement('button');
      pinBtn.type = 'button';
      pinBtn.className = 'pin-trigger';
      pinBtn.dataset.messageId = String(messageId);
      pinBtn.textContent = 'ê³µì§€ ê³ ì •';
      contentWrap.appendChild(pinBtn);
    }

    const mentionByPayload = Array.isArray(mentionUserIds) && mentionUserIds.some(id => String(id) === String(currentUserId));
    const mentionByText = containsMentionForMe(message || '');
    const mentionForMe = mentionByPayload || mentionByText;
    if (mentionForMe) row.classList.add('mention-me');

    row.appendChild(senderEl);
    row.appendChild(contentWrap);
    chatLog.appendChild(row);
    chatLog.scrollTop = chatLog.scrollHeight;

    if (document.hidden && String(senderId) !== String(currentUserId)) {
      if (mentionForMe) {
        hiddenMentionCount += 1;
      } else {
        hiddenMessageCount += 1;
      }
      updateHiddenTitle();
    }

    updateMessageCount();
    applyMentionFilter();
  }

  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      hiddenMessageCount = 0;
      hiddenMentionCount = 0;
      updateHiddenTitle();
    }
  });

  function renderPartyAction() {
    if (!partyActionContainer) return;

    if (isHost) {
      partyActionContainer.innerHTML = `
        <form action="/parties/${partyId}/leave/" method="post" onsubmit="return confirm('íŒŒí‹°ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\\në‹¤ìŒ ì°¸ì—¬ìì—ê²Œ ë°©ì¥ ê¶Œí•œì´ ìœ„ì„ë©ë‹ˆë‹¤.');">
          <input type="hidden" name="csrfmiddlewaretoken" value="${escapeHtml(csrftoken)}">
          <button type="submit" class="btn" style="width:100%;background:#ff5c5c;border-color:#ff5c5c;">ë°©ì¥ ê¶Œí•œ ë„˜ê¸°ê³  ë‚˜ê°€ê¸°</button>
        </form>
      `;
      return;
    }

    if (isMember) {
      partyActionContainer.innerHTML = `
        <form action="/parties/${partyId}/leave/" method="post" onsubmit="return confirm('ì •ë§ íŒŒí‹°ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?');">
          <input type="hidden" name="csrfmiddlewaretoken" value="${escapeHtml(csrftoken)}">
          <button type="submit" class="btn btn-ghost" style="width:100%;">íŒŒí‹° ë‚˜ê°€ê¸°</button>
        </form>
      `;
      return;
    }

    if (joinPolicy === 'APPROVAL' && myJoinRequestStatus === 'PENDING') {
      partyActionContainer.innerHTML = `
        <form action="/parties/${partyId}/join/cancel/" method="post">
          <input type="hidden" name="csrfmiddlewaretoken" value="${escapeHtml(csrftoken)}">
          <button type="submit" class="btn btn-ghost" style="width:100%;">ì‹ ì²­ ì·¨ì†Œ</button>
        </form>
      `;
      return;
    }

    if (myWaitlistRank > 0) {
      partyActionContainer.innerHTML = `<button type="button" class="btn btn-ghost" style="width:100%;cursor:not-allowed;" disabled>ëŒ€ê¸°ì—´ ${myWaitlistRank}ë²ˆ</button>`;
      return;
    }

    if (joinPolicy !== 'APPROVAL') {
      if (currentCount >= maxMembers) {
        partyActionContainer.innerHTML = `
          <form action="/parties/${partyId}/join/" method="post">
            <input type="hidden" name="csrfmiddlewaretoken" value="${escapeHtml(csrftoken)}">
            <button type="submit" class="btn btn-solid" style="width:100%;">ëŒ€ê¸°ì—´ ì°¸ê°€</button>
          </form>
        `;
        return;
      }
    }

    const joinLabel = joinPolicy === 'APPROVAL' ? 'ì°¸ê°€ ì‹ ì²­í•˜ê¸°' : 'íŒŒí‹° ì°¸ì—¬í•˜ê¸°';
    partyActionContainer.innerHTML = `
      <form action="/parties/${partyId}/join/" method="post">
        <input type="hidden" name="csrfmiddlewaretoken" value="${escapeHtml(csrftoken)}">
        <button type="submit" class="btn btn-solid" style="width:100%;">${joinLabel}</button>
      </form>
    `;
  }

  function renderRequestItem(req) {
    return `
      <div class="request-item" id="join-request-${req.id}">
        <div style="font-size:.92rem;">${escapeHtml(req.nickname)}</div>
        <div class="request-actions">
          <form action="/parties/${partyId}/join-requests/${req.id}/approve/" method="post">
            <input type="hidden" name="csrfmiddlewaretoken" value="${escapeHtml(csrftoken)}">
            <button type="submit" class="btn btn-solid">ìˆ˜ë½</button>
          </form>
          <form action="/parties/${partyId}/join-requests/${req.id}/reject/" method="post">
            <input type="hidden" name="csrfmiddlewaretoken" value="${escapeHtml(csrftoken)}">
            <button type="submit" class="btn btn-ghost">ê±°ì ˆ</button>
          </form>
        </div>
      </div>
    `;
  }

  function syncRequestPanelEmpty() {
    if (!requestList) return;
    const hasItems = requestList.querySelectorAll('.request-item').length > 0;
    let emptyEl = document.getElementById('request-empty');
    if (!hasItems && !emptyEl) {
      requestList.insertAdjacentHTML('beforeend', '<p id="request-empty" style="color:var(--muted);font-size:.84rem;margin:8px 0 0;">ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>');
    }
    if (hasItems && emptyEl) emptyEl.remove();
  }

  function updateRequestPanelVisibility() {
    if (!requestPanel) return;
    requestPanel.style.display = (isHost && joinPolicy === 'APPROVAL') ? 'block' : 'none';
  }

  function renderWaitlist(entries, count) {
    if (waitlistCountEl) waitlistCountEl.textContent = `${count}ëª…`;

    const mine = (entries || []).find(item => String(item.user_id) === String(currentUserId));
    myWaitlistRank = mine ? Number(mine.rank) : 0;

    if (myWaitlistRankEl) {
      myWaitlistRankEl.textContent = myWaitlistRank > 0
        ? `ë‚´ ëŒ€ê¸° ìˆœë²ˆ: ${myWaitlistRank}ë²ˆ`
        : 'ë‚´ ëŒ€ê¸° ìƒíƒœ: ë¯¸ë“±ë¡';
    }

    if (waitlistListEl) {
      waitlistListEl.innerHTML = '';
      if (!entries || entries.length === 0) {
        waitlistListEl.innerHTML = '<p id=\"waitlist-empty\" style=\"margin:8px 0 0;color:var(--muted);font-size:.84rem;\">ëŒ€ê¸°ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      } else {
        entries.forEach(item => {
          waitlistListEl.insertAdjacentHTML(
            'beforeend',
            `<div class=\"wait-item\" data-user-id=\"${item.user_id}\">${item.rank}. ${escapeHtml(item.nickname)}</div>`
          );
        });
      }
    }

    renderPartyAction();
  }

  function applyPartyMeta(party) {
    if (!party) return;
    const modeEl = document.getElementById('party-mode-label');
    const descEl = document.getElementById('party-desc-label');
    const micEl = document.getElementById('mic-badge');
    const joinPolicyEl = document.getElementById('join-policy-badge');
    const statusEl = document.getElementById('party-status');

    if (modeEl) modeEl.textContent = party.title || party.mode || '';
    if (descEl) descEl.textContent = party.description || 'íŒŒí‹° ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
    if (statusEl) statusEl.textContent = party.status || '';
    if (party.current_count !== undefined) {
      currentCount = parseFiniteNumber(party.current_count, currentCount);
    }

    maxMembers = parseFiniteNumber(party.max_members, maxMembers);
    syncProgressBar(currentCount, maxMembers);
    if (micEl) micEl.style.display = party.mic_required ? '' : 'none';
    if (joinPolicyEl) joinPolicyEl.style.display = party.join_policy === 'APPROVAL' ? '' : 'none';
    renderPartyAction();
  }

  function applyPinnedNotice(pinned) {
    if (!pinned || !pinned.content) {
      if (pinnedNoticeEl) pinnedNoticeEl.style.display = 'none';
      if (pinnedContentEl) pinnedContentEl.textContent = '';
      if (pinnedMetaEl) pinnedMetaEl.textContent = '';
      return;
    }

    if (pinnedNoticeEl) pinnedNoticeEl.style.display = '';
    if (pinnedContentEl) pinnedContentEl.textContent = pinned.content || '';
    if (pinnedMetaEl) pinnedMetaEl.textContent = `ì‘ì„±ì: ${pinned.sender || 'ì‹œìŠ¤í…œ'}`;
  }

  function getMentionQueryState(text, caretIndex) {
    const left = text.slice(0, caretIndex);
    const atPos = left.lastIndexOf('@');
    if (atPos < 0) return null;

    const prefix = left.slice(atPos + 1);
    if (prefix.includes(' ') || prefix.includes('\n')) return null;
    if (prefix.length > 24) return null;
    return { start: atPos, end: caretIndex, query: prefix };
  }

  function hideMentionSuggest() {
    mentionState = null;
    mentionActiveIndex = -1;
    if (mentionSuggest) {
      mentionSuggest.innerHTML = '';
      mentionSuggest.style.display = 'none';
    }
  }

  function renderMentionSuggest() {
    if (!mentionSuggest || !mentionState || mentionCandidates.length === 0) {
      hideMentionSuggest();
      return;
    }

    mentionSuggest.innerHTML = '';
    mentionCandidates.forEach((name, idx) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = `mention-option${idx === mentionActiveIndex ? ' active' : ''}`;
      btn.dataset.name = name;
      btn.textContent = `@${name}`;
      mentionSuggest.appendChild(btn);
    });
    mentionSuggest.style.display = '';
  }

  function refreshMentionCandidates(rawMembers) {
    mentionNames.clear();
    (rawMembers || []).forEach(member => {
      if (member.nickname) mentionNames.add(String(member.nickname));
    });
  }

  function updateMentionSuggestFromInput(inputDom) {
    if (!inputDom || !mentionSuggest) return;
    const state = getMentionQueryState(inputDom.value, inputDom.selectionStart || 0);
    if (!state) {
      hideMentionSuggest();
      return;
    }

    const query = state.query.toLowerCase();
    const names = Array.from(mentionNames).filter(Boolean);
    mentionCandidates = names
      .filter(name => name.toLowerCase().startsWith(query))
      .slice(0, 8);
    mentionState = state;
    mentionActiveIndex = mentionCandidates.length ? 0 : -1;
    renderMentionSuggest();
  }

  function applyMentionSelection(inputDom, name) {
    if (!inputDom || !mentionState) return;

    const left = inputDom.value.slice(0, mentionState.start);
    const right = inputDom.value.slice(mentionState.end);
    const replacement = `@${name} `;
    inputDom.value = `${left}${replacement}${right}`;

    const nextPos = (left + replacement).length;
    inputDom.focus();
    inputDom.setSelectionRange(nextPos, nextPos);
    hideMentionSuggest();
  }

  function syncPinButtonsForHost() {
    if (pinnedClearBtn) {
      pinnedClearBtn.style.display = isHost ? '' : 'none';
    }
    chatLog.querySelectorAll('.message-row[data-chat-message="1"]').forEach(row => {
      const messageId = row.dataset.messageId;
      const content = row.querySelector('.message-content');
      if (!content || !messageId) return;

      const existingBtn = row.querySelector('.pin-trigger');
      if (isHost && !existingBtn) {
        const pinBtn = document.createElement('button');
        pinBtn.type = 'button';
        pinBtn.className = 'pin-trigger';
        pinBtn.dataset.messageId = messageId;
        pinBtn.textContent = 'ê³µì§€ ê³ ì •';
        content.appendChild(pinBtn);
      }
      if (!isHost && existingBtn) {
        existingBtn.remove();
      }
    });
  }

  const copyInviteBtn = document.getElementById('copy-invite');
  if (copyInviteBtn) {
    copyInviteBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        copyInviteBtn.textContent = 'ë³µì‚¬ ì™„ë£Œ';
        setTimeout(() => { copyInviteBtn.textContent = 'ì´ˆëŒ€ ë§í¬ ë³µì‚¬'; }, 1400);
      } catch (_) {
        copyInviteBtn.textContent = 'ë³µì‚¬ ì‹¤íŒ¨';
      }
    });
  }

  function openTransferModal(userId, userName) {
    const modal = document.getElementById('host-transfer-modal');
    const form = document.getElementById('host-transfer-form');
    const msg = document.getElementById('host-transfer-message');
    msg.textContent = `${userName}ë‹˜ì—ê²Œ ë°©ì¥ ê¶Œí•œì„ ë„˜ê¹ë‹ˆë‹¤.`;
    form.action = `/parties/${partyId}/members/${userId}/transfer-host/`;
    modal.style.display = 'flex';
  }

  function closeTransferModal() {
    document.getElementById('host-transfer-modal').style.display = 'none';
  }

  document.addEventListener('click', (e) => {
    const mentionOption = e.target.closest('.mention-option');
    if (mentionOption) {
      const inputDom = document.getElementById('chat-message-input');
      applyMentionSelection(inputDom, mentionOption.dataset.name || '');
      return;
    }

    const pinTrigger = e.target.closest('.pin-trigger');
    if (pinTrigger) {
      if (!isHost) return;
      const messageId = pinTrigger.dataset.messageId;
      if (!messageId) return;

      fetch(`/parties/${partyId}/pin/${messageId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
      })
        .then(async (res) => {
          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data.ok) {
            appendSystemMessage((data && data.error) || 'ê³µì§€ ê³ ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', '#ffb5a9');
            return;
          }
          applyPinnedNotice(data.pinned);
          appendSystemMessage('ğŸ“Œ ê³µì§€ê°€ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', '#9bdcff');
        })
        .catch(() => appendSystemMessage('ê³µì§€ ê³ ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', '#ffb5a9'));
      return;
    }

    const trigger = e.target.closest('.transfer-trigger');
    if (!trigger) return;
    openTransferModal(trigger.dataset.userId, trigger.dataset.userName);
  });

  const hostTransferForm = document.getElementById('host-transfer-form');
  if (hostTransferForm) {
    hostTransferForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      try {
        const res = await fetch(hostTransferForm.action, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest',
          },
          credentials: 'same-origin',
        });

        if (!res.ok) {
          appendSystemMessage('ë°©ì¥ ìœ„ì„ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', '#ffb5a9');
          return;
        }

        const data = await res.json();
        closeTransferModal();
        appendSystemMessage(`ğŸ‘‘ ${data.transferred_user_name}ë‹˜ì´ ìƒˆë¡œìš´ ë°©ì¥ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`, '#9bdcff');
      } catch (_) {
        appendSystemMessage('ë°©ì¥ ìœ„ì„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', '#ffb5a9');
      }
    });
  }

  if (pinnedClearBtn) {
    pinnedClearBtn.addEventListener('click', async () => {
      try {
        const res = await fetch(`/parties/${partyId}/pin/clear/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest',
          },
          credentials: 'same-origin',
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          appendSystemMessage((data && data.error) || 'ê³µì§€ í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', '#ffb5a9');
          return;
        }

        applyPinnedNotice(null);
        appendSystemMessage('ğŸ“Œ ê³ ì • ê³µì§€ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', '#9bdcff');
      } catch (_) {
        appendSystemMessage('ê³µì§€ í•´ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', '#ffb5a9');
      }
    });
  }

  const partySettingsForm = document.getElementById('party-settings-form');
  if (partySettingsForm) {
    partySettingsForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(partySettingsForm);
      if (!formData.has('mic_required')) {
        formData.set('mic_required', 'off');
      }

      try {
        const res = await fetch(partySettingsForm.action, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest',
          },
          credentials: 'same-origin',
          body: formData,
        });

        const data = await res.json();
        if (!res.ok || !data.ok) {
          appendSystemMessage((data.errors && data.errors.join(' ')) || 'ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', '#ffb5a9');
          return;
        }

        appendSystemMessage('âš™ï¸ íŒŒí‹° ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', '#9bdcff');
        applyPartyMeta({
          mode: data.party.mode,
          description: data.party.description,
          mic_required: data.party.mic_required,
          max_members: data.party.max_members,
          status: data.party.status,
          join_policy: joinPolicy,
        });
      } catch (_) {
        appendSystemMessage('ì„¤ì • ì €ì¥ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', '#ffb5a9');
      }
    });
  }

  const params = new URLSearchParams(window.location.search);
  if (params.get('requested') === '1') {
    appendSystemMessage('ì°¸ê°€ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ë°©ì¥ ìˆ˜ë½ ì‹œ ì…ì¥ë˜ë©°, ì •ì› ì´ˆê³¼ ì‹œ ëŒ€ê¸°ì—´ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.', '#9bdcff');
  }
  if (params.get('request_cancelled') === '1') {
    appendSystemMessage('ì°¸ê°€ ì‹ ì²­ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.', '#9bdcff');
  }
  if (params.get('full') === '1') {
    appendSystemMessage('í˜„ì¬ íŒŒí‹° ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.', '#ffb5a9');
  }
  if (params.get('approve_failed') === 'full') {
    appendSystemMessage('ì •ì›ì´ ê°€ë“ ì°¨ì„œ ì‹ ì²­ì„ ìˆ˜ë½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', '#ffb5a9');
  }
  if (params.get('moved_waitlist') === '1') {
    appendSystemMessage('ì‹ ì²­ì´ ìˆ˜ë½ë˜ì–´ ëŒ€ê¸°ì—´ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', '#9bdcff');
  }
  if (params.get('waitlisted') === '1') {
    const rank = params.get('rank');
    appendSystemMessage(`ëŒ€ê¸°ì—´ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.${rank ? ` (í˜„ì¬ ${rank}ë²ˆ)` : ''}`, '#9bdcff');
  }
  if (params.get('settings_updated') === '1') {
    appendSystemMessage('âš™ï¸ íŒŒí‹° ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', '#9bdcff');
  }
  if (params.get('settings_failed') === '1') {
    appendSystemMessage('íŒŒí‹° ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', '#ffb5a9');
  }
  const kickedUserName = params.get('kicked_user_name');
  if (kickedUserName) {
    appendSystemMessage(`ğŸš« ${kickedUserName}ë‹˜ì´ ê°•ì œ ì¶”ë°©ë˜ì—ˆìŠµë‹ˆë‹¤.`, '#ff8d8d');
  }
  const hostTransferredName = params.get('host_transferred_name');
  if (hostTransferredName) {
    appendSystemMessage(`ğŸ‘‘ ${hostTransferredName}ë‹˜ì´ ìƒˆë¡œìš´ ë°©ì¥ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`, '#9bdcff');
  }
  ['requested', 'request_cancelled', 'full', 'approve_failed', 'moved_waitlist', 'waitlisted', 'rank', 'settings_updated', 'settings_failed', 'kicked_user_name', 'host_transferred_name'].forEach(k => params.delete(k));
  const nextQuery = params.toString();
  history.replaceState({}, '', `${window.location.pathname}${nextQuery ? `?${nextQuery}` : ''}`);

  if (mentionFilterBtn) {
    mentionFilterBtn.addEventListener('click', () => {
      mentionFilterOnly = !mentionFilterOnly;
      applyMentionFilter();
    });
  }

  chatLog.scrollTop = chatLog.scrollHeight;
  updateMessageCount();
  updateRequestPanelVisibility();
  syncProgressBar(currentCount, maxMembers);
  requestAnimationFrame(() => {
    syncProgressBar(currentCount, maxMembers);
  });
  applyPinnedNotice(
    {% if pinned_notice %}
      { message_id: "{{ pinned_notice.message_id }}", content: "{{ pinned_notice.content|escapejs }}", sender: "{{ pinned_notice.sender|escapejs }}" }
    {% else %}
      null
    {% endif %}
  );
  decorateExistingMentions();
  syncPinButtonsForHost();

  const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
  const chatSocket = new WebSocket(protocol + window.location.host + '/ws/chat/' + partyId + '/');

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);

    if (data.type === 'chat_message') {
      appendChatMessage({
        messageId: data.message_id,
        sender: data.sender,
        senderId: data.sender_id,
        message: data.message,
        mentionUserIds: data.mention_user_ids || [],
      });
      return;
    }

    if (data.type === 'chat_error') {
      appendSystemMessage(data.message || 'ì±„íŒ… ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', '#ffb5a9');
      return;
    }

    if (data.type === 'system_message') {
      if (
        (data.code === 'host_transferred' || data.code === 'party_settings_updated')
        && String(data.actor_user_id) === String(currentUserId)
      ) {
        return;
      }
      appendSystemMessage(data.message || 'ì‹œìŠ¤í…œ ë©”ì‹œì§€');
      return;
    }

    if (data.type === 'count_update') {
      const statusEl = document.getElementById('party-status');
      currentCount = parseFiniteNumber(data.count, currentCount);
      syncProgressBar(currentCount, maxMembers);
      if (statusEl) statusEl.textContent = currentCount >= maxMembers ? 'ë§ˆê°' : 'ëª¨ì§‘ì¤‘';
      renderPartyAction();
      return;
    }

    if (data.type === 'member_list_update') {
      const listContainer = document.getElementById('member-list-container');
      if (!listContainer) return;

      listContainer.innerHTML = '';
      const me = data.members.find(member => String(member.id) === String(currentUserId));
      isMember = Boolean(me);
      isHost = Boolean(me && me.is_host);
      if (isMember) myWaitlistRank = 0;
      syncProgressBar((data.members || []).length, maxMembers);
      renderPartyAction();
      updateRequestPanelVisibility();
      refreshMentionCandidates(data.members || []);
      syncPinButtonsForHost();

      data.members.forEach(member => {
        const isMe = String(member.id) === String(currentUserId);
        let actions = '';
        if (isHost && !member.is_host) {
          actions = `
            <div class="member-actions">
              <button type="button" class="icon-btn transfer-trigger" data-user-id="${member.id}" data-user-name="${escapeHtml(member.nickname)}">ìœ„ì„</button>
              <form action="/parties/${partyId}/members/${member.id}/kick/" method="post" onsubmit="return confirm('ì •ë§ ${escapeHtml(member.nickname)}ë‹˜ì„ ê°•í‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                <input type="hidden" name="csrfmiddlewaretoken" value="${escapeHtml(csrftoken)}">
                <button type="submit" class="icon-btn warn">ê°•í‡´</button>
              </form>
            </div>
          `;
        }

        listContainer.insertAdjacentHTML(
          'beforeend',
          `<div class="member-item"><span>${escapeHtml(member.nickname)} ${member.is_host ? 'ğŸ‘‘' : ''} ${isMe ? '<span style="color:var(--ok);font-size:.8rem;">(ë‚˜)</span>' : ''}</span>${actions}</div>`
        );
      });
      return;
    }

    if (data.type === 'waitlist_update') {
      renderWaitlist(data.entries || [], Number(data.count || 0));
      return;
    }

    if (data.type === 'party_meta_update') {
      applyPartyMeta(data.party);
      return;
    }

    if (data.type === 'pinned_notice_update') {
      applyPinnedNotice(data.pinned || null);
      return;
    }

    if (data.type === 'join_request_update') {
      if (!isHost || joinPolicy !== 'APPROVAL') return;
      if (!requestList) return;

      if (pendingRequestCount) pendingRequestCount.textContent = `${data.pending_count || 0}ê±´`;
      const req = data.request;
      const exists = document.getElementById(`join-request-${req.id}`);

      if (data.action === 'created' && !exists) {
        const emptyEl = document.getElementById('request-empty');
        if (emptyEl) emptyEl.remove();
        requestList.insertAdjacentHTML('beforeend', renderRequestItem(req));
      }

      if ((data.action === 'approved' || data.action === 'rejected' || data.action === 'queued' || data.action === 'cancelled') && exists) {
        exists.remove();
      }

      syncRequestPanelEmpty();
      return;
    }

    if (data.type === 'join_request_result') {
      if (String(data.target_user_id) !== String(currentUserId)) return;
      myJoinRequestStatus = data.status;
      const positive = data.status === 'APPROVED' || data.status === 'WAITLISTED' || data.status === 'CANCELLED';
      appendSystemMessage(data.message || 'ì‹ ì²­ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', positive ? '#9bdcff' : '#ffb5a9');

      if (data.status === 'APPROVED') {
        setTimeout(() => window.location.reload(), 700);
      } else {
        renderPartyAction();
      }
      return;
    }

    if (data.type === 'user_kicked') {
      if (String(data.kicked_user_id) === String(currentUserId)) {
        document.getElementById('kick-modal').style.display = 'flex';
      } else {
        appendSystemMessage(`ğŸš« ${data.kicked_user_name}ë‹˜ì´ ê°•ì œ ì¶”ë°©ë˜ì—ˆìŠµë‹ˆë‹¤.`, '#ff8d8d');
      }
      return;
    }

    if (data.type === 'party_killed') {
      if (!isHost) {
        document.getElementById('party-end-modal').style.display = 'flex';
      }
    }
  };

  const inputDom = document.getElementById('chat-message-input');
  const submitBtn = document.getElementById('chat-message-submit');
  const sendChatMessage = () => {
    if (!inputDom || !submitBtn) return;
    if (isTextComposing || Date.now() < ignoreEnterUntil) return;

    const now = Date.now();
    if (now - lastSendAt < 120) return;

    const message = inputDom.value.replace(/\r?\n/g, '').trim();
    if (!message) return;

    lastSendAt = now;
    chatSocket.send(JSON.stringify({ message }));
    inputDom.value = '';
    hideMentionSuggest();
  };

  if (inputDom && submitBtn) {
    inputDom.focus();
    inputDom.addEventListener('compositionstart', () => {
      isTextComposing = true;
      ignoreEnterUntil = Date.now() + 350;
    });
    inputDom.addEventListener('compositionend', () => {
      isTextComposing = false;
      // ì¼ë¶€ IME/ë¸Œë¼ìš°ì €ëŠ” ì¡°í•© í™•ì • ì§í›„ Enter keydownì´ ì¶”ê°€ ë°œìƒí•¨.
      ignoreEnterUntil = Date.now() + 250;
      updateMentionSuggestFromInput(inputDom);
    });
    inputDom.addEventListener('input', () => {
      if (isTextComposing) return;
      updateMentionSuggestFromInput(inputDom);
    });
    inputDom.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (isImeComposing(e) || Date.now() < ignoreEnterUntil)) {
        suppressEnterKeyup = true;
        return;
      }
      if (isImeComposing(e)) return;

      if (mentionSuggest && mentionSuggest.style.display !== 'none' && mentionCandidates.length > 0) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          mentionActiveIndex = (mentionActiveIndex + 1) % mentionCandidates.length;
          renderMentionSuggest();
          return;
        }
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          mentionActiveIndex = (mentionActiveIndex - 1 + mentionCandidates.length) % mentionCandidates.length;
          renderMentionSuggest();
          return;
        }
        if (e.key === 'Tab' || e.key === 'Enter') {
          const picked = mentionCandidates[Math.max(mentionActiveIndex, 0)];
          if (picked) {
            e.preventDefault();
            if (e.key === 'Enter') suppressEnterKeyup = true;
            applyMentionSelection(inputDom, picked);
            return;
          }
        }
      }

      if (e.key === 'Enter') {
        if (mentionSuggest && mentionSuggest.style.display !== 'none' && mentionCandidates.length > 0) {
          // EnterëŠ” keyup ì „ì†¡ìœ¼ë¡œ ì²˜ë¦¬. ì—¬ê¸°ì„œëŠ” ì…ë ¥ì°½ ê¸°ë³¸ ë™ì‘ë§Œ ë§‰ìŒ.
          e.preventDefault();
        }
      }
    });
    inputDom.addEventListener('keyup', (e) => {
      if (e.key !== 'Enter') return;
      if (suppressEnterKeyup) {
        suppressEnterKeyup = false;
        return;
      }
      if (isImeComposing(e) || isTextComposing || Date.now() < ignoreEnterUntil) return;
      sendChatMessage();
    });
    inputDom.addEventListener('blur', () => {
      setTimeout(() => hideMentionSuggest(), 120);
    });
    submitBtn.addEventListener('click', sendChatMessage);
  }

  renderPartyAction();
  syncRequestPanelEmpty();

  window.closeTransferModal = closeTransferModal;
</script>
{% endblock %}
